{% extends "base.html" %}

{% block title %}åˆ†ç±»ç®¡ç† - MindWeaver{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <h2 class="page-title">åˆ†ç±»ç®¡ç†</h2>
        <div class="page-actions">
            <button class="btn btn-primary" id="add-category-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                æ·»åŠ åˆ†ç±»
            </button>
        </div>
    </div>

    <div class="page-content">
        <div id="categories-table"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize categories table
const categoriesTable = new DataTable({
    container: '#categories-table',
    dataUrl: '/api/categories',
    loadData: async (params) => {
        // Categories API returns flat array, handle pagination locally
        const result = await API.categories.list();
        if (result.success || result.data) {
            let data = result.data || result;
            const total = data.length;
            const start = (params.page - 1) * params.pageSize;
            const end = start + params.pageSize;
            const items = data.slice(start, end);
            return { items, total };
        }
        return { items: [], total: 0 };
    },
    columns: [
        {
            key: 'name',
            label: 'åç§°',
            render: (row) => {
                const icon = row.icon ? `<span style="margin-right: 8px;">${row.icon}</span>` : '';
                return `
                    <div class="cell-title">${icon}${row.name}</div>
                    ${row.description ? `<div class="cell-meta">${row.description}</div>` : ''}
                `;
            }
        },
        {
            key: 'color',
            label: 'é¢œè‰²',
            render: (row) => {
                if (!row.color) return '-';
                return `
                    <span class="badge" style="background-color: ${row.color}; color: white;">
                        ${row.color}
                    </span>
                `;
            }
        },
        {
            key: 'feed_count',
            label: 'è®¢é˜…æºæ•°',
            render: (row) => {
                return row.feed_count ?? row.feeds_count ?? 0;
            }
        },
        {
            key: 'enabled',
            label: 'çŠ¶æ€',
            render: (row) => {
                return row.enabled !== false
                    ? '<span class="badge badge-success" style="font-size: 0.75rem;">å¯ç”¨</span>'
                    : '<span class="badge badge-default" style="font-size: 0.75rem;">ç¦ç”¨</span>';
            }
        }
    ],
    rowActions: (row) => [
        {
            name: 'toggle',
            label: row.enabled !== false ? 'ç¦ç”¨' : 'å¯ç”¨',
            icon: row.enabled !== false ?
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' :
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4 11H8v-2h8v2z"/></svg>',
            onClick: `toggleCategory(${row.id}, ${row.enabled !== false})`
        },
        {
            name: 'edit',
            label: 'ç¼–è¾‘',
            icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',
            onClick: `editCategory(${row.id})`
        },
        {
            name: 'delete',
            label: 'åˆ é™¤',
            icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>',
            danger: true,
            onClick: `deleteCategory(${row.id})`
        }
    ],
    rowId: 'id',
    pageSize: 50,
    emptyMessage: 'æš‚æ— åˆ†ç±»ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ '
});

// Add category button
document.getElementById('add-category-btn')?.addEventListener('click', () => {
    showCategoryForm();
});

// Show category form (add/edit)
async function showCategoryForm(categoryId = null) {
    let categoryData = {};

    // Load category data if editing
    if (categoryId) {
        const result = await API.categories.get(categoryId);
        if (result.success) {
            categoryData = result.data;
        } else {
            Toast.error('åŠ è½½æ•°æ®å¤±è´¥');
            return;
        }
    }

    const isEdit = !!categoryId;
    const title = isEdit ? 'ç¼–è¾‘åˆ†ç±»' : 'æ·»åŠ åˆ†ç±»';

    const formHTML = `
        <form id="category-form">
            <div class="form-group">
                <label for="category-name">åç§° *</label>
                <input type="text" id="category-name" name="name" required value="${categoryData.name || ''}" placeholder="è¾“å…¥åˆ†ç±»åç§°">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="category-color">é¢œè‰²</label>
                    <input type="color" id="category-color" name="color" value="${categoryData.color || '#1a73e8'}" style="height: 40px; padding: 4px;">
                </div>
                <div class="form-group">
                    <label for="category-icon">å›¾æ ‡</label>
                    <input type="text" id="category-icon" name="icon" value="${categoryData.icon || ''}" placeholder="ğŸ“ æˆ– emoji">
                </div>
            </div>
            <div class="form-group">
                <label for="category-description">æè¿°</label>
                <textarea id="category-description" name="description" rows="3" placeholder="å¯é€‰çš„åˆ†ç±»æè¿°">${categoryData.description || ''}</textarea>
            </div>
        </form>
    `;

    const footer = `
        <button class="btn btn-secondary" data-cancel>å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary" form="category-form">${isEdit ? 'ä¿å­˜' : 'æ·»åŠ '}</button>
    `;

    Forms.showModal(formHTML, { title, footer });

    // Handle form submission
    const form = document.getElementById('category-form');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = Forms.getFormData(form);

        const result = await (isEdit ?
            API.categories.update(categoryId, formData) :
            API.categories.create(formData)
        );

        if (result.success) {
            Toast.success(isEdit ? 'åˆ†ç±»æ›´æ–°æˆåŠŸ' : 'åˆ†ç±»æ·»åŠ æˆåŠŸ');
            Forms.closeModal();
            categoriesTable.refresh();
        } else {
            Toast.error(result.error || 'æ“ä½œå¤±è´¥');
        }
    });
}

// Toggle category enabled
async function toggleCategory(id, currentEnabled) {
    const result = await API.categories.toggle(id);
    if (result.success) {
        Toast.success(currentEnabled ? 'å·²ç¦ç”¨' : 'å·²å¯ç”¨');
        categoriesTable.refresh();
    } else {
        Toast.error(result.error || 'æ“ä½œå¤±è´¥');
    }
}

// Edit category
function editCategory(id) {
    showCategoryForm(id);
}

// Delete category
function deleteCategory(id) {
    Forms.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿåˆ é™¤åè®¢é˜…æºå°†å˜ä¸º"æœªåˆ†ç±»"çŠ¶æ€ã€‚', {
        title: 'åˆ é™¤åˆ†ç±»',
        confirmText: 'åˆ é™¤',
        onConfirm: async () => {
            const result = await API.categories.delete(id);
            if (result.success) {
                Toast.success('åˆ é™¤æˆåŠŸ');
                categoriesTable.refresh();
            } else {
                Toast.error(result.error || 'åˆ é™¤å¤±è´¥');
            }
        }
    });
}

// Register keyboard shortcuts
Keyboard.register('n', () => showCategoryForm(), 'æ–°å»ºåˆ†ç±»');
Keyboard.register('r', () => categoriesTable.refresh(), 'åˆ·æ–°åˆ—è¡¨');
</script>
{% endblock %}
