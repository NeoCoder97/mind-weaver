{% extends "base.html" %}

{% block title %}文章列表 - MindWeaver{% endblock %}

{% block header_actions %}
<div class="search-box">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
    </svg>
    <input type="text" id="search-input" placeholder="搜索文章..." value="{{ search_query }}">
</div>
{% endblock %}

{% block content %}
<div class="page">
    <div class="toolbar">
        <div class="toolbar-left">
            <div class="toolbar-group" id="batch-actions" style="display: none;">
                <span class="selected-count">已选 <span id="selected-count">0</span> 项</span>
                <button class="btn btn-ghost btn-sm" id="batch-mark-read">标记已读</button>
                <button class="btn btn-ghost btn-sm" id="batch-delete">删除</button>
            </div>
            <div class="toolbar-group">
                <select id="feed-filter">
                    <option value="">所有订阅源</option>
                    {% for feed in feeds %}
                    <option value="{{ feed.id }}" {% if feed_id == feed.id %}selected{% endif %}>{{ feed.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary btn-sm" id="refresh-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
                刷新
            </button>
        </div>
    </div>

    <div class="page-content">
        <div id="entries-table"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize entries table
const entriesTable = new DataTable({
    container: '#entries-table',
    dataUrl: '/api/entries',
    columns: [
        {
            key: 'title',
            label: '标题',
            render: (row) => {
                const readClass = row.enabled ? 'font-weight: 500;' : '';
                const hasContent = row.full_content ? '<span class="badge badge-success" style="margin-left: 8px;">全文</span>' : '';
                return `
                    <div class="cell-title" style="${readClass}">
                        <a href="/entry/${row.id}">${row.title || '(无标题)'}</a>
                        ${hasContent}
                    </div>
                `;
            }
        },
        {
            key: 'feed_name',
            label: '来源',
            render: (row) => {
                return `<span class="text-secondary">${row.feed_name || '-'}</span>`;
            }
        },
        {
            key: 'published_at',
            label: '发布时间',
            type: 'datetime',
            render: (row) => {
                return new Date(row.published_at).toLocaleString('zh-CN', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        },
        {
            key: 'language',
            label: '语言',
            render: (row) => {
                const langMap = { 'zh': '中文', 'en': '英文', 'ja': '日文', 'unknown': '-' };
                return langMap[row.language] || row.language || '-';
            }
        },
        {
            key: 'reading_time_seconds',
            label: '时长',
            render: (row) => {
                if (!row.reading_time_seconds) return '-';
                const minutes = Math.ceil(row.reading_time_seconds / 60);
                return minutes > 0 ? `${minutes} min` : '< 1 min';
            }
        },
        {
            key: 'tags',
            label: '标签',
            render: (row) => {
                if (!row.tags) return '-';
                try {
                    const tags = JSON.parse(row.tags);
                    const displayTags = tags.slice(0, 3);
                    const extra = tags.length > 3 ? `+${tags.length - 3}` : '';
                    return displayTags.map(tag => `<span class="badge badge-default" style="margin-right: 4px; font-size: 0.7rem;">${tag}</span>`).join('') +
                           (extra ? `<span class="text-muted" style="font-size: 0.7rem;">${extra}</span>` : '');
                } catch {
                    return '-';
                }
            }
        },
        {
            key: 'enabled',
            label: '状态',
            type: 'boolean',
            render: (row) => {
                return row.enabled ?
                    '<span class="badge badge-success" style="font-size: 0.75rem;">未读</span>' :
                    '<span class="badge badge-default" style="font-size: 0.75rem;">已读</span>';
            }
        }
    ],
    rowActions: (row) => [
        {
            name: 'toggle-read',
            label: row.enabled ? '标记已读' : '标记未读',
            icon: row.enabled ?
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' :
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
            onClick: `toggleReadStatus(${row.id}, ${row.enabled})`
        },
        {
            name: 'delete',
            label: '删除',
            icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>',
            danger: true,
            onClick: `deleteEntry(${row.id})`
        }
    ],
    rowId: 'id',
    pageSize: 20,
    selectable: true,
    initialParams: {
        feed_id: {{ feed_id or 'null' }},
        q: '{{ search_query }}'
    },
    onSelectionChange: (ids) => {
        updateBatchActions(ids);
    }
});

// Toggle read status (enabled: true = 未读, false = 已读)
async function toggleReadStatus(id, currentEnabled) {
    const result = await API.entries.put(id, { enabled: !currentEnabled });
    if (result.success) {
        Toast.success(currentEnabled ? '已标记为已读' : '已标记为未读');
        entriesTable.refresh();
    } else {
        Toast.error(result.error || '操作失败');
    }
}

// Delete entry
async function deleteEntry(id) {
    Forms.confirm('确定要删除这篇文章吗？', {
        title: '删除文章',
        confirmText: '删除',
        onConfirm: async () => {
            const result = await API.entries.delete(id);
            if (result.success) {
                Toast.success('删除成功');
                entriesTable.refresh();
            } else {
                Toast.error(result.error || '删除失败');
            }
        }
    });
}

// Update batch actions visibility
function updateBatchActions(selectedIds) {
    const batchActions = document.getElementById('batch-actions');
    const selectedCount = document.getElementById('selected-count');

    if (selectedIds.length > 0) {
        batchActions.style.display = 'flex';
        selectedCount.textContent = selectedIds.length;
    } else {
        batchActions.style.display = 'none';
    }
}

// Batch mark as read
document.getElementById('batch-mark-read')?.addEventListener('click', async () => {
    const ids = entriesTable.getSelectedIds();
    if (ids.length === 0) return;

    const result = await API.entries.batchMarkRead(ids);
    if (result.success) {
        Toast.success(`已标记 ${ids.length} 篇文章为已读`);
        entriesTable.clearSelection();
        entriesTable.refresh();
    } else {
        Toast.error(result.error || '操作失败');
    }
});

// Batch delete
document.getElementById('batch-delete')?.addEventListener('click', async () => {
    const ids = entriesTable.getSelectedIds();
    if (ids.length === 0) return;

    Forms.confirm(`确定要删除选中的 ${ids.length} 篇文章吗？`, {
        title: '批量删除',
        confirmText: '删除',
        onConfirm: async () => {
            const result = await API.entries.batchDelete(ids);
            if (result.success) {
                Toast.success(`删除成功`);
                entriesTable.clearSelection();
                entriesTable.refresh();
            } else {
                Toast.error(result.error || '删除失败');
            }
        }
    });
});

// Refresh button
document.getElementById('refresh-btn')?.addEventListener('click', () => {
    entriesTable.refresh();
});

// Feed filter
document.getElementById('feed-filter')?.addEventListener('change', (e) => {
    const feedId = e.target.value ? parseInt(e.target.value) : null;
    entriesTable.setFilters({ feed_id: feedId });
});

// Search (debounced)
let searchTimeout;
document.getElementById('search-input')?.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        entriesTable.setFilters({ q: e.target.value || null });
    }, 300);
});

// Register keyboard shortcuts
Keyboard.register('a', () => entriesTable.toggleSelectAll(), '全选/取消全选');
Keyboard.register('r', () => entriesTable.refresh(), '刷新列表');
Keyboard.register('/', () => {
    document.getElementById('search-input')?.focus();
    return false; // Prevent default
}, '聚焦搜索框');
</script>
{% endblock %}
