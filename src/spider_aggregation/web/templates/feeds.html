{% extends "base.html" %}

{% block title %}订阅源管理 - MindWeaver{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <h2 class="page-title">订阅源管理</h2>
        <div class="page-actions">
            <button class="btn btn-primary" id="add-feed-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                添加订阅源
            </button>
        </div>
    </div>

    <div class="page-content">
        <div id="feeds-table"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize feeds table
const feedsTable = new DataTable({
    container: '#feeds-table',
    dataUrl: '/api/feeds',
    columns: [
        {
            key: 'name',
            label: '名称',
            render: (row) => {
                return `
                    <div class="cell-title">
                        <a href="${row.url}" target="_blank" rel="noopener">${row.name}</a>
                    </div>
                    <div class="cell-meta">${row.url}</div>
                `;
            }
        },
        {
            key: 'category_name',
            label: '分类',
            render: (row) => {
                return row.category_name ? `<span class="badge badge-default">${row.category_name}</span>` : '-';
            }
        },
        {
            key: 'interval',
            label: '抓取频率',
            render: (row) => {
                return `${row.interval} 分钟`;
            }
        },
        {
            key: 'last_fetch_at',
            label: '最后抓取',
            type: 'datetime'
        },
        {
            key: 'error_count',
            label: '错误次数',
            render: (row) => {
                const errorClass = row.error_count > 5 ? 'error' : (row.error_count > 0 ? 'warning' : 'success');
                const statusText = row.error_count > 5 ? '多次失败' : (row.error_count > 0 ? `${row.error_count} 次` : '正常');
                return `<span class="text-${errorClass}">${statusText}</span>`;
            }
        },
        {
            key: 'enabled',
            label: '状态',
            type: 'status'
        }
    ],
    rowActions: (row) => [
        {
            name: 'fetch',
            label: '立即抓取',
            icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>',
            onClick: `fetchFeed(${row.id})`
        },
        {
            name: 'edit',
            label: '编辑',
            icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',
            onClick: `editFeed(${row.id})`
        },
        {
            name: 'toggle',
            label: row.enabled ? '禁用' : '启用',
            icon: row.enabled ?
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' :
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4 11H8v-2h8v2z"/></svg>',
            onClick: `toggleFeed(${row.id}, ${row.enabled})`
        },
        {
            name: 'delete',
            label: '删除',
            icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>',
            danger: true,
            onClick: `deleteFeed(${row.id})`
        }
    ],
    rowId: 'id',
    pageSize: 50,
    emptyMessage: '暂无订阅源，点击上方按钮添加'
});

// Add feed button
document.getElementById('add-feed-btn')?.addEventListener('click', () => {
    showFeedForm();
});

// Show feed form (add/edit)
async function showFeedForm(feedId = null) {
    let feedData = {};
    let categories = [];

    // Load categories
    const catsResult = await API.categories.list();
    if (catsResult.success) {
        categories = catsResult.data || catsResult;
    }

    // Load feed data if editing
    if (feedId) {
        const result = await API.feeds.get(feedId);
        if (result.success) {
            feedData = result.data;
        } else {
            Toast.error('加载订阅源数据失败');
            return;
        }
    }

    const isEdit = !!feedId;
    const title = isEdit ? '编辑订阅源' : '添加订阅源';

    // Build category options
    const categoryOptions = categories.map(cat =>
        `<option value="${cat.id}" ${feedData.category_id === cat.id ? 'selected' : ''}>${cat.name}</option>`
    ).join('');

    const formHTML = `
        <form id="feed-form">
            <div class="form-group">
                <label for="feed-name">名称 *</label>
                <input type="text" id="feed-name" name="name" required value="${feedData.name || ''}" placeholder="输入订阅源名称">
            </div>
            <div class="form-group">
                <label for="feed-url">URL *</label>
                <input type="url" id="feed-url" name="url" required value="${feedData.url || ''}" placeholder="https://example.com/feed.xml">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="feed-category">分类</label>
                    <select id="feed-category" name="category_id">
                        <option value="">未分类</option>
                        ${categoryOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label for="feed-interval">抓取频率 (分钟)</label>
                    <input type="number" id="feed-interval" name="interval" min="5" value="${feedData.interval || 60}">
                </div>
            </div>
            <div class="form-group">
                <label for="feed-description">描述</label>
                <textarea id="feed-description" name="description" rows="3" placeholder="可选的订阅源描述">${feedData.description || ''}</textarea>
            </div>
        </form>
    `;

    const footer = `
        <button class="btn btn-secondary" data-cancel>取消</button>
        <button type="submit" class="btn btn-primary" form="feed-form">${isEdit ? '保存' : '添加'}</button>
    `;

    Forms.showModal(formHTML, { title, footer });

    // Handle form submission
    const form = document.getElementById('feed-form');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = Forms.getFormData(form);
        const url = isEdit ? `/api/feeds/${feedId}` : '/api/feeds';
        const method = isEdit ? 'PUT' : 'POST';

        const result = await (isEdit ? API.feeds.update(feedId, formData) : API.feeds.create(formData));

        if (result.success) {
            Toast.success(isEdit ? '订阅源更新成功' : '订阅源添加成功');
            Forms.closeModal();
            feedsTable.refresh();
        } else {
            Toast.error(result.error || '操作失败');
        }
    });
}

// Edit feed
function editFeed(id) {
    showFeedForm(id);
}

// Fetch feed
async function fetchFeed(id) {
    const result = await API.feeds.fetch(id);
    if (result.success) {
        Toast.success('抓取任务已触发');
    } else {
        Toast.error(result.error || '触发抓取失败');
    }
}

// Toggle feed
async function toggleFeed(id, currentStatus) {
    const result = await API.feeds.toggle(id);
    if (result.success) {
        Toast.success(currentStatus ? '已禁用' : '已启用');
        feedsTable.refresh();
    } else {
        Toast.error(result.error || '操作失败');
    }
}

// Delete feed
function deleteFeed(id) {
    Forms.confirm('确定要删除这个订阅源吗？删除后不会删除已抓取的文章。', {
        title: '删除订阅源',
        confirmText: '删除',
        onConfirm: async () => {
            const result = await API.feeds.delete(id);
            if (result.success) {
                Toast.success('删除成功');
                feedsTable.refresh();
            } else {
                Toast.error(result.error || '删除失败');
            }
        }
    });
}

// Register keyboard shortcuts
Keyboard.register('n', () => showFeedForm(), '新建订阅源');
Keyboard.register('r', () => feedsTable.refresh(), '刷新列表');
</script>
{% endblock %}
